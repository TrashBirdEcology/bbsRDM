---
title: "A simple run through of RDM with BBS data"
author: "Jessica Burnett"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

```

There are a lot of dependencies to load here.

```{r , message=FALSE, warning = FALSE}
## Re-install often as this package is under major development.
devtools::install_github("trashbirdecology/regimedetectionmeasures", force = T)
library(regimeDetectionMeasures)
library(sp)
library(raster)
library(feather)
library(bbsRDM)
library(here)
```

First we need to create some directories to hold the intermediate data.
```{r}
# a. Create a directory to store and/or load the BBS data as feathers
bbsDir <- here::here("bbs_raw_data")
dir.create(bbsDir)
# if this returns a warning, proceed with caution as directory already exists
# and may contain results.

# b. Create a directory to store and/or load the BBS data as feathers
resultsDir <- here::here("myResults")
dir.create(resultsDir)
# ditto
```

If necessary, download all the state data. This takes 10-15 minutes, so don't do
this more than once if possible!

```{r , eval = FALSE}
# o. Load the regional .txt file from Patuxent
regions <- GetRegions()
# Create a series or one filenames for states, regions
regionFileName <- regions$zipFileName %>% na.omit()
# a.  Download and unzip the BBS data.
for(i in 1:length(regionFileName)){
        bbsData <-  importDataBBS(
            # arguments for getDataBBS()
            file = regionFileName[i],
            dir =  "ftp://ftpext.usgs.gov/pub/er/md/laurel/BBS/DataFiles/States/",
            year = NULL,
            aou = NULL,
            countrynum = NULL,
            states = NULL,
            #  arguments for getRouteInfo():
            routesFile = "routes.zip",
            routesDir =  "ftp://ftpext.usgs.gov/pub/er/md/laurel/BBS/DataFiles/",
            RouteTypeID = 1,
            # one or more of c(1,2,3)
            Stratum = NULL,
            BCR = NULL
        )


# b. Save the file to disk
birdsToFeathers(dataIn  = bbsData,
                newDir  = bbsDir,
                filename = regionFileName[i])

rm(bbsData)

} # end section I. loop

```

Next we build the sampling grid to force route information onto a regular grid.

```{r}
# III: Build sampling grid --------------------------------------------------------
# Define the grid's cell size (lat, long; unit:degrees)
# 1 deg latitude ~= 69 miles
# 1 deg longitude ~= 55 miles
cs <-
    c(0.5, 0.5)  # default is cell size 0.5 deg lat x 0.5 deg long

# Create the grid
routes_gridList <- createSamplingGrid(cs = cs)
routes_grid <- routes_gridList$routes_grid
sp_grd <- routes_gridList$sp_grd

rm(cs)

```

Now we load in the BBS data from the feathers and overlay the sampling grid. This takes
a bit, and creates a pretty large object if memory is an issue.

```{r, message=FALSE}
feathers <- NULL
featherNames <- list.files(bbsDir)
featherNames <- str_c("/",featherNames) #add separator
for (i in 1:length(featherNames)) {
  feather <- NULL
  feather <- loadBirdFeathers(newDir  = bbsDir,
                              filename = featherNames[i]) %>%
    dplyr::rename(lat = latitude,
                  long = longitude) %>%
    left_join(routes_grid, by = c("countrynum", "statenum", "route", "lat", "long"))
  
  feathers <- rbind(feathers, feather)
  rm(feather)
}
```

Nearly there! Now we define the parameters for the regime shift detectors.

```{r}
metrics.to.calc <- c("distances", "ews")
analySpatTemp <-
    "South-North" # choose one of : 'South-North', 'East-West', or 'temporal'
fill = 0
min.samp.sites = 15
min.window.dat = 3
fi.equation = "7.12"
winMove = 0.25
to.calc = c("EWS", "FI", "VI")

# II: Create a dataset for analysis -----------------------------------------------------

# a. Subset the data according to year, colID, rowID, state, country, etc.
birdData <- feathers %>%
    filter(year == 2015,
           colID == 81) %>% 
            # rowID == 14
            # statenum == 2,
            # route == 14) %>%
dplyr::rename(variable = aou,
              value = stoptotal)

# b. Munge the data further
    dataIn <- birdData %>%
        dplyr::rename(time = lat) %>%
        dplyr::select(-year, -long)
    timeVar = 'lat'
    colInd = unique(birdData$colID)
    yearInd = unique(birdData$year)
    if(length(colInd)!=1){stop("dataIn is incorrect: check filtering.")}

# III. Calculate the metrics ---------------------------------------------------

    # keep only the relevant columns
    dataInDist  <- dataIn %>%
        dplyr::select(
            time, variable, value)

    # Calc distances
    results_distance <- calculate_distanceTravelled(dataInDist, derivs = T) %>%
        gather(key = 'metricType', value ='metricValue', -time)

    rm(dataInDist)

# f.ii.a Calculate the EWSs
    # keep only the relevant columns
    dataInRDM  <- dataIn %>%
        dplyr::select(
            time, variable, value)

    if(length(unique(dataInRDM$time)) < min.samp.sites){stop("data has less observations than min.samp.sites")}

    results_ews <-
        rdm_window_analysis(
            dataIn = dataInRDM,
            winMove = winMove,
            overrideSiteErr = F,
            fi.equation = fi.equation,
            min.window.dat = min.window.dat,
            fill = fill,
            to.calc = to.calc)

    rm(dataInRDM)

```

And now we're ready to visualize!

